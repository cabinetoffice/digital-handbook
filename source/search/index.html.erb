---
title: "Search results"
layout: "custom"
---

<section class="govuk-width-container">
  <h1 class="govuk-heading-l">Search results</h1>

  <div id="search-summary" class="govuk-body"></div>
  <div id="search-results" class="govuk-!-margin-top-4"></div>
</section>

<script>
(function () {
  // ---------- small helpers (ES5) ----------
  function getParam(name) {
    var m = new RegExp('[?&]' + name + '=([^&]+)').exec(location.search);
    return m ? decodeURIComponent(m[1].replace(/\+/g, ' ')) : '';
  }
  function safeHref(url) {
    var u = String(url || '').trim();
    if (/^\s*javascript:/i.test(u) || !u) return '#';
    return u;
  }
  function clear(node){ while (node.firstChild) node.removeChild(node.firstChild); }

  // Build a short snippet and highlight the FIRST occurrence
  function buildSnippetNode(text, q) {
    var span = document.createElement('span');
    if (!text || !q) return span;

    var t = String(text);
    var lc = t.toLowerCase();
    var ql = String(q).toLowerCase();

    var pos = lc.indexOf(ql);
    var start = Math.max(0, pos - 60);
    var end   = Math.min(t.length, (pos > -1 ? pos + q.length + 60 : 160));
    var slice = t.slice(start, end);

    if (start > 0) span.appendChild(document.createTextNode('…'));

    if (pos === -1) {
      span.appendChild(document.createTextNode(slice));
      if (end < t.length) span.appendChild(document.createTextNode('…'));
      return span;
    }

    var rel = pos - start;
    if (rel > 0) span.appendChild(document.createTextNode(slice.slice(0, rel)));

    var mark = document.createElement('mark');
    mark.appendChild(document.createTextNode(slice.substr(rel, q.length)));
    span.appendChild(mark);

    var tail = slice.slice(rel + q.length);
    if (tail) span.appendChild(document.createTextNode(tail));

    if (end < t.length) span.appendChild(document.createTextNode('…'));
    return span;
  }

  // ---------- main ----------
  var q = (getParam('q') || '').trim();
  var summary = document.getElementById('search-summary');
  var outlet  = document.getElementById('search-results');

  if (!q) {
    summary.textContent = 'Type a query in the search box and press Enter.';
    return;
  }
  summary.textContent = 'Results for "' + q + '"';

  // Relative path so it works under /digital-handbook/ in prod
  fetch('search.json')
    .then(function (r) { return r.json(); })
    .then(function (docs) {
      var i, d;
      for (i = 0; i < docs.length; i++) {
        d = docs[i];
        d._lt = (d.title || '').toLowerCase();
        d._lc = (d.content || '').toLowerCase();
      }

      var ql = q.toLowerCase();
      var hits = [];
      for (i = 0; i < docs.length; i++) {
        d = docs[i];
        if (d._lt.indexOf(ql) > -1 || d._lc.indexOf(ql) > -1) hits.push(d);
      }

      clear(outlet);

      if (hits.length === 0) {
        var p = document.createElement('p');
        p.className = 'govuk-body';
        p.appendChild(document.createTextNode('No results found.'));
        outlet.appendChild(p);
        return;
      }

      var frag = document.createDocumentFragment();
      for (i = 0; i < hits.length; i++) {
        d = hits[i];
        var url = safeHref(d.url);
        var wrap = document.createElement('div');
        wrap.className = 'govuk-!-margin-bottom-6';

        var h2 = document.createElement('h2');
        h2.className = 'govuk-heading-m govuk-!-margin-bottom-1';
        var a = document.createElement('a');
        a.className = 'govuk-link';
        a.setAttribute('href', url);
        a.appendChild(document.createTextNode(String(d.title || url)));
        h2.appendChild(a);
        wrap.appendChild(h2);

        var p1 = document.createElement('p');
        p1.className = 'govuk-body govuk-!-margin-bottom-1';
        var small = document.createElement('small');
        small.appendChild(buildSnippetNode(d.content || '', q));
        p1.appendChild(small);
        wrap.appendChild(p1);

        var p2 = document.createElement('p');
        p2.className = 'govuk-body-s';
        var a2 = document.createElement('a');
        a2.className = 'govuk-link';
        a2.setAttribute('href', url);
        a2.appendChild(document.createTextNode(url));
        p2.appendChild(a2);
        wrap.appendChild(p2);

        frag.appendChild(wrap);
      }
      outlet.appendChild(frag);
    })
    .catch(function () {
      clear(outlet);
      var p = document.createElement('p');
      p.className = 'govuk-body';
      p.appendChild(document.createTextNode('There was a problem loading search results.'));
      outlet.appendChild(p);
    });
})();
</script>
